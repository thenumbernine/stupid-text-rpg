<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Stupid</title>
		<script type='text/javascript' src='../../js/jquery-1.10.0.min.js'></script>
		<script type='text/javascript'>
var outputElement;
//init Module here, for use later in lua.vm.js
var stdoutLine = '';
var stderrLine = '';
var Module = {
	print: function(s) {
		//console.log("print: "+s);
		outputElement.value = (outputElement.value ? outputElement.value + '\n' : '') + x;
	}
/* I thought overriding these would be a good idea because otherwise it seems errors go to never never land ...
but it's only caused more harm than good
	stdout : function(s) { 
		if (s == 10 || s == 13 || s === null) {
			console.log("stdout: "+stdoutLine);
			stdoutLine = '';
		} else {
			stdoutLine += String.fromCharCode(s);
			if (stdoutLine.length >= 80) {
				console.log("stdout: "+stdoutLine);
				stdoutLine = '';
			}
		}
	},
	stderr : function(s) {
		if (s == 10 || s == 13 || s === null) {
			console.log("stderr: "+stderrLine);
			stderrLine = '';
		} else {
			stderrLine += String.fromCharCode(s);
			if (stderrLine.length >= 80) {
				console.log("stderr: "+stderrLine);
				stderrLine = '';
			}
		}
	}
*/
};

		</script>
		<script type='text/javascript' src='lua.vm.js'></script>
		<script type='text/javascript'>

var luafiles = [
'box.lua',
'map.lua',
'unit.lua',
'jobs.lua',
'util.lua',
'vec.lua',
'army.lua',
'battle.lua',
'ext/io.lua',
'ext/init.lua',
'ext/table.lua',
'ext/math.lua',
'ext/serialize.lua',
'ext/string.lua',
'ext/class.lua',
//'launch_gl.lua',
'treasure.lua',
'monster.lua',
'client.lua',
'items.lua',
'player.lua',
'entity.lua',
'log.lua',
//'launch_text.lua',
'launch_js.lua',
'view.lua',
'stupid.lua'
];

var fileContents = {};
function doneLoadingFilesystem() {
	Lua.execute(fileContents['launch_js.lua']);
}

function getLuaRequiredFile(fn) {
	fn = fn.replace('.', '/');
	var result = undefined;
	$.each([
		'?.lua',
		'?/init.lua'
	], function(_,pattern){
		var fullfn = pattern.replace('?', fn);
		if (fullfn in fileContents) {
			result = fileContents[fullfn];
			return true;	//break;
		}
	});
	return result;
}

function clearOutput() {
	outputElement.value = '';
}

function setOutput(str) {
	console.log("setOutput: "+str);
	outputElement.value = str;
}

var keyBuffer = [];
function getLastKey() {
	if (keyBuffer.length == 0) return;
	return keyBuffer.splice(0, 1)[0];
}
$(document).ready(function() {
	
	$(window).keydown(function(e) {
		keyBuffer.push(String.fromCharCode(e.which));
	});

	outputElement = document.getElementById('output');
	var doneCount = 0;
	$.each(luafiles, function(_,path) {
		//preload, but with text ...
		$.ajax({
			url:path
		}).fail(function() {
			throw "failed to precache file "+path;
		}).done(function(data) {
			var lastSlash = path.lastIndexOf('/');
			var filename;
			if (lastSlash == -1) {
				filename = path;
			} else {
				var dir = path.substring(0, lastSlash);
				try { 	//how do you detect if a path is already created?
					FS.createPath('/', dir, true, true);
				} catch (e) {
				}
				filename = path.substring(lastSlash+1);
			}
			for (var i = 0; i < data.length; ++i) {
				var ch = data.charCodeAt(i);
				if ((ch < 32 || ch > 127) && 	//is valid
					ch != 9 && 					//\t
					ch != 10) 					//\n
				{
					throw "file "+path+" has bad char "+ch+" at "+i;
				}
			}
			fileContents[path] = data;
			FS.createDataFile(dir, filename, data, true, false);
			++doneCount;
			if (doneCount == luafiles.length) {
				console.log('Done Loading Filesystem!');
				doneLoadingFilesystem();
			}
		});
	});	
});
		</script>
	</head>
	<body>
		<textarea id='output' readonly="readonly" cols=81 rows=26></textarea>
	</body>
</html>
