<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Stupid</title>
		<script type='text/javascript' src='../../js/jquery-1.10.0.min.js'></script>
		<script type='text/javascript'>
var printBuffer = '';
var printElement = undefined;
//init Module here, for use later in lua.vm.js
function printOutAndErr(s) {
	console.log("print: "+s);
	if (printBuffer !== '') printBuffer += '\n';
	printBuffer += s
	printElement.html(printBuffer
		.replace(new RegExp('&', 'g'), '&amp;')
		.replace(new RegExp('<', 'g'), '&lt;')
		.replace(new RegExp('>', 'g'), '&gt;')
		.replace(new RegExp('"', 'g'), '&quot;')
		.replace(new RegExp('\n', 'g'), '<br>')
		.replace(new RegExp(' ', 'g'), '&nbsp;')
	);
	$(document).scrollTop($(document).height()); 
}

function clearOutput() {
	printElement.html(printBuffer = '');
}

function setOutput(str) {
	printElement.text(
		str
		//.replace(new RegExp('&', 'g'), '&amp;')
		.replace(new RegExp('<', 'g'), '&lt;')
		.replace(new RegExp('>', 'g'), '&gt;')
		.replace(new RegExp('"', 'g'), '&quot;')
	);
}

var Module = {
	print : printOutAndErr,
	printErr : printOutAndErr,
	stdin : function() {} 
};
		</script>
		<script type='text/javascript' src='lua.vm.js'></script>
		<script type='text/javascript'>

//TODO don't store them here
//just pull from https://raw.github.com/thenumbernine/stupid-text-rpg/master/
var luafiles = [
	'box.lua',
	'map.lua',
	'unit.lua',
	'jobs.lua',
	'util.lua',
	'vec.lua',
	'army.lua',
	'battle.lua',
	'ext/io.lua',
	'ext/init.lua',
	'ext/table.lua',
	'ext/math.lua',
	'ext/serialize.lua',
	'ext/string.lua',
	'ext/class.lua',
	//'launch_gl.lua',
	'treasure.lua',
	'monster.lua',
	'client.lua',
	'items.lua',
	'player.lua',
	'entity.lua',
	'log.lua',
	//'launch_text.lua',
	'launch_js.lua',
	'view.lua',
	'stupid.lua'
];

var lastCmd = null; 

//update if there are any stored input commands
function update() {
	if (lastCmd !== null) {
		Lua.execute('launcher.update("'+lastCmd+'")');
		lastCmd = null;
	}
}

function doneLoadingFilesystem() {

	//set up input handler
	$(window).keydown(function(e) {
		switch (e.keyCode) {
		case 37:	//left
			lastCmd = 'left';
			break;
		case 38:	//up
			lastCmd = 'up';
			break;
		case 39:	//right
			lastCmd = 'right';
			break;
		case 40:	//down
			lastCmd = 'down';
			break;
		case 32:	//space
			lastCmd = 'space';
			break;
		case 13:	//enter
			lastCmd = 'enter';
			break;
		default:
			var key = String.fromCharCode(e.which).toLowerCase();
			if (key == 'q') key = 'quit';
			lastCmd = key;
			break;
		}
	});
	setInterval(update, 100);

	//launch first file
	Lua.execute([
		"package.path = package.path .. ';./?/init.lua'",
		"require 'launch_js'"
	].join('\n'));
}

$(document).ready(function() {
	printElement = $('#print');
	var doneCount = 0;
	$.each(luafiles, function(_,path) {
		//preload
		$.ajax({
			url:path
		}).fail(function() {
			throw "failed to precache file "+path;
		}).done(function(data) {
			
			//pull apart filename and directory path 
			var lastSlash = path.lastIndexOf('/');
			var filename;
			if (lastSlash == -1) {
				filename = path;
			} else {
				var dir = path.substring(0, lastSlash);
				try { 	//how do you detect if a path is already created?
					FS.createPath('/', dir, true, true);
				} catch (e) {
				}
				filename = path.substring(lastSlash+1);
			}

			FS.createDataFile(dir, filename, data, true, false);
			
			++doneCount;
			if (doneCount == luafiles.length) {
				console.log('Done Loading Filesystem!');
				doneLoadingFilesystem();
			}
		});
	});	
});
		</script>
	</head>
	<body>
		<div id='print' style='width:90%; border:1px solid black; font-family:Courier'></div>
	</body>
</html>
