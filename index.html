<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Stupid</title>
		<script type='text/javascript' src='../../js/jquery-1.10.0.min.js'></script>
		<script type='text/javascript'>
var printBuffer = '';
var printElement = undefined;
//init Module here, for use later in lua.vm.js
function printOutAndErr(s) {
	console.log("print: "+s);
	if (printBuffer !== '') printBuffer += '\n';
	printBuffer += s
	printElement.html(printBuffer
		.replace(new RegExp('&', 'g'), '&amp;')
		.replace(new RegExp('<', 'g'), '&lt;')
		.replace(new RegExp('>', 'g'), '&gt;')
		.replace(new RegExp('"', 'g'), '&quot;')
		.replace(new RegExp('\n', 'g'), '<br>')
		.replace(new RegExp(' ', 'g'), '&nbsp;')
	);
	$(document).scrollTop($(document).height()); 
}

function clearOutput() {
	printElement.html(printBuffer = '');
}

function setOutput(str) {
	printElement.text(
		str
		//.replace(new RegExp('&', 'g'), '&amp;')
		.replace(new RegExp('<', 'g'), '&lt;')
		.replace(new RegExp('>', 'g'), '&gt;')
		.replace(new RegExp('"', 'g'), '&quot;')
	);
}

var Module = {
	print : printOutAndErr,
	printErr : printOutAndErr,
	stdin : function() {} 
};
		</script>
		<script type='text/javascript' src='lua.vm.js'></script>
		<script type='text/javascript'>

//TODO don't store them here
//just pull from https://raw.github.com/thenumbernine/stupid-text-rpg/master/
var luafiles = [
	'box.lua',
	'map.lua',
	'unit.lua',
	'jobs.lua',
	'util.lua',
	'vec.lua',
	'army.lua',
	'battle.lua',
	'ext/io.lua',
	'ext/init.lua',
	'ext/table.lua',
	'ext/math.lua',
	'ext/serialize.lua',
	'ext/string.lua',
	'ext/class.lua',
	//'launch_gl.lua',
	'treasure.lua',
	'monster.lua',
	'client.lua',
	'items.lua',
	'player.lua',
	'entity.lua',
	'log.lua',
	//'launch_text.lua',
	'launch_js.lua',
	'view.lua',
	'stupid.lua'
];

var cmdBuffer = [];
function getLastCmd() {
	var key;
	if (cmdBuffer.length == 0) {
		key = String.fromCharCode(0);
	} else {
		key = cmdBuffer.splice(0,1)[0];
	}
	//Module.print('polling key '+key+' byte '+key.charCodeAt(0));
	return key; 
}

//update if there are any stored input commands
function update() {
	if (cmdBuffer.length > 0) {
		//for console stupid i have input gather after render.
		//this is so the user can react to what is displayed.
		//it could go before render if an initial render was performed.
		//unfortunately for lua.vm.js, i haven't managed to get coroutine.yield wrapping everything to facilitate blocking input,
		//so i had to unravel the update loop and collect input outside.
		//the tradeoff is now we react to input without a redraw.  hence why i have two updates. the first gets input, the second redraws
		Lua.execute('launcher.update()');
		Lua.execute('launcher.update()');

	}
}

function doneLoadingFilesystem() {

	//set up input handler
	$(window).keydown(function(e) {
		//Module.print('in keydown for code '+e.keyCode+' which '+String.fromCharCode(e.which));
		switch (e.keyCode) {
		case 37:	//left
			cmdBuffer.push('left');
			e.preventDefault();
			break;
		case 38:	//up
			cmdBuffer.push('up');
			e.preventDefault();
			break;
		case 39:	//right
			cmdBuffer.push('right');
			e.preventDefault();
			break;
		case 40:	//down
			cmdBuffer.push('down');
			e.preventDefault();
			break;
		case 32:	//space
			cmdBuffer.push('space');
			break;
		case 13:	//enter
			cmdBuffer.push('enter');
			break;
		default:
			var key = String.fromCharCode(e.which).toLowerCase();
			if (key == 'q') key = 'quit';
			cmdBuffer.push(key);
			break;
		}
	});
	setInterval(update, 100);

	//launch first file
	Lua.execute([
		"package.path = package.path .. ';./?/init.lua'",
		"require 'launch_js'"
	].join('\n'));
}

$(document).ready(function() {
	printElement = $('#print');
	var doneCount = 0;
	$.each(luafiles, function(_,path) {
		//preload
		$.ajax({
			url:path
		}).fail(function() {
			throw "failed to precache file "+path;
		}).done(function(data) {
			
			//pull apart filename and directory path 
			var lastSlash = path.lastIndexOf('/');
			var filename;
			if (lastSlash == -1) {
				filename = path;
			} else {
				var dir = path.substring(0, lastSlash);
				try { 	//how do you detect if a path is already created?
					FS.createPath('/', dir, true, true);
				} catch (e) {
				}
				filename = path.substring(lastSlash+1);
			}

			FS.createDataFile(dir, filename, data, true, false);
			
			++doneCount;
			if (doneCount == luafiles.length) {
				console.log('Done Loading Filesystem!');
				doneLoadingFilesystem();
			}
		});
	});	
});
		</script>
	</head>
	<body>
		<div id='print' style='width:90%; border:1px solid black; font-family:Courier'></div>
	</body>
</html>
